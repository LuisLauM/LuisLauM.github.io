<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-10-25">
<meta name="description" content="Running R scripts in marbec-gpu. | Ejecutar scripts de R en marbec-gpu.">

<title>Running an R script into marbec-gpu – Beneath the surface 🌊</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon-wave.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Beneath the surface 🌊</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
  <ul>
  <li><a href="#en-lets-working-with-marbec-gpu" id="toc-en-lets-working-with-marbec-gpu" class="nav-link active" data-scroll-target="#en-lets-working-with-marbec-gpu">[EN] Let’s working with <code>marbec-gpu</code></a>
  <ul class="collapse">
  <li><a href="#lets-tidy-up-a-bit" id="toc-lets-tidy-up-a-bit" class="nav-link" data-scroll-target="#lets-tidy-up-a-bit">Let’s tidy up a bit</a>
  <ul class="collapse">
  <li><a href="#creating-a-working-directory" id="toc-creating-a-working-directory" class="nav-link" data-scroll-target="#creating-a-working-directory">Creating a working directory</a></li>
  <li><a href="#creating-an-rstudio-project" id="toc-creating-an-rstudio-project" class="nav-link" data-scroll-target="#creating-an-rstudio-project">Creating an RStudio project</a></li>
  </ul></li>
  <li><a href="#hello-world-simple-examples" id="toc-hello-world-simple-examples" class="nav-link" data-scroll-target="#hello-world-simple-examples"><code>Hello world!</code> (simple examples)</a>
  <ul class="collapse">
  <li><a href="#example-1-1" id="toc-example-1-1" class="nav-link" data-scroll-target="#example-1-1">Example 1-1</a></li>
  <li><a href="#example-1-2" id="toc-example-1-2" class="nav-link" data-scroll-target="#example-1-2">Example 1-2</a></li>
  </ul></li>
  <li><a href="#hello-universe-parallel-process" id="toc-hello-universe-parallel-process" class="nav-link" data-scroll-target="#hello-universe-parallel-process"><code>Hello universe!</code> (parallel process)</a>
  <ul class="collapse">
  <li><a href="#example-2-1-a-loop-in-a-single-core" id="toc-example-2-1-a-loop-in-a-single-core" class="nav-link" data-scroll-target="#example-2-1-a-loop-in-a-single-core">Example 2-1: A loop in a single core</a></li>
  <li><a href="#example-2-2-a-loop-on-multiple-cores" id="toc-example-2-2-a-loop-on-multiple-cores" class="nav-link" data-scroll-target="#example-2-2-a-loop-on-multiple-cores">Example 2-2: A loop on multiple cores</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#es-empezando-a-trabajar-con-marbec-gpu" id="toc-es-empezando-a-trabajar-con-marbec-gpu" class="nav-link" data-scroll-target="#es-empezando-a-trabajar-con-marbec-gpu">[ES] Empezando a trabajar con <code>marbec-gpu</code></a>
  <ul class="collapse">
  <li><a href="#un-poco-de-orden" id="toc-un-poco-de-orden" class="nav-link" data-scroll-target="#un-poco-de-orden">Un poco de orden</a>
  <ul class="collapse">
  <li><a href="#creando-un-directorio-de-trabajo" id="toc-creando-un-directorio-de-trabajo" class="nav-link" data-scroll-target="#creando-un-directorio-de-trabajo">Creando un directorio de trabajo</a></li>
  <li><a href="#creando-un-proyecto-de-rstudio" id="toc-creando-un-proyecto-de-rstudio" class="nav-link" data-scroll-target="#creando-un-proyecto-de-rstudio">Creando un proyecto de RStudio</a></li>
  </ul></li>
  <li><a href="#hello-world-ejemplos-sencillos" id="toc-hello-world-ejemplos-sencillos" class="nav-link" data-scroll-target="#hello-world-ejemplos-sencillos"><code>Hello world!</code> (ejemplos sencillos)</a>
  <ul class="collapse">
  <li><a href="#ejemplo-1-1" id="toc-ejemplo-1-1" class="nav-link" data-scroll-target="#ejemplo-1-1">Ejemplo 1-1</a></li>
  <li><a href="#ejemplo-1-2" id="toc-ejemplo-1-2" class="nav-link" data-scroll-target="#ejemplo-1-2">Ejemplo 1-2</a></li>
  </ul></li>
  <li><a href="#hello-universe-procesos-en-paralelo" id="toc-hello-universe-procesos-en-paralelo" class="nav-link" data-scroll-target="#hello-universe-procesos-en-paralelo"><code>Hello universe!</code> (procesos en paralelo)</a>
  <ul class="collapse">
  <li><a href="#ejemplo-2-1-un-bucle-en-un-solo-núcleo" id="toc-ejemplo-2-1-un-bucle-en-un-solo-núcleo" class="nav-link" data-scroll-target="#ejemplo-2-1-un-bucle-en-un-solo-núcleo">Ejemplo 2-1: Un bucle en un solo núcleo</a></li>
  <li><a href="#ejemplo-2-2-un-bucle-en-múltiples-núcleos" id="toc-ejemplo-2-2-un-bucle-en-múltiples-núcleos" class="nav-link" data-scroll-target="#ejemplo-2-2-un-bucle-en-múltiples-núcleos">Ejemplo 2-2: Un bucle en múltiples núcleos</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<div class="quarto-about-marquee">
  <div class="about-image-container">
    <img src="banner.jpg" class="about-image
  rectangle " style="width: 100%;">
  </div>
  <div class="about-contents">
    <header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Running an R script into <code>marbec-gpu</code></h1>
</div>
<div>
  <div class="description">
    <p>Running R scripts in <code>marbec-gpu</code>. | Ejecutar scripts de R en <code>marbec-gpu</code>.</p>
  </div>
</div>
<div class="quarto-title-meta">
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 25, 2024</p>
    </div>
  </div>
  </div>
</header> <main class="content" id="quarto-document-content">

<p>Image credits: Андрей Сизов at <a href="https://unsplash.com/photos/a-book-with-a-diagram-on-it-nuz3rK5iiKg?utm_content=creditShareLink&amp;utm_medium=referral&amp;utm_source=unsplash">Unplash</a></p>
<section id="en-lets-working-with-marbec-gpu" class="level1">
<h1>[EN] Let’s working with <code>marbec-gpu</code></h1>
<section id="lets-tidy-up-a-bit" class="level2">
<h2 data-anchor-id="lets-tidy-up-a-bit">Let’s tidy up a bit</h2>
<section id="creating-a-working-directory" class="level3">
<h3 data-anchor-id="creating-a-working-directory">Creating a working directory</h3>
<p>As when working with RStudio locally (i.e.&nbsp;on our PC), it is recommended to clearly define our working directory. This is extremely important because any process we run (either from RStudio or Terminal) will use that directory as a reference to find input files, output files or even other scripts.</p>
<p>For our case, we have created a folder called <strong>mgpu-examples/</strong> where there is a subfolder called <strong>code/</strong>. The creation of folders in <code>marbec-data</code> can be done directly from the web interface (by clicking on <em>File station</em> and then using the <em>Create folder</em> button), the command <code>mkdir</code>, but we can also copy-paste the elements already existing in our PC into the working folder.</p>
</section>
<section id="creating-an-rstudio-project" class="level3">
<h3 data-anchor-id="creating-an-rstudio-project">Creating an RStudio project</h3>
<p>The following is NOT mandatory, but very useful, especially when working with RStudio and that is to create an RStudio project. To do this, we will go to <em>File</em> and then <em>New Project</em>.</p>
<p><img src="images/clipboard-334464964.png" class="img-fluid"></p>
<p>Then, in the window that appears, click on <em>Existing directory</em>, then on <em>Browse</em> and click on the folder that we have defined as our working directory (in our case, <em>mgpu-examples/</em>). Then, <em>OK</em> and finally click on the <em>Create Project</em> button. Rstudio will flicker a little bit and then will show us the same window, but inside the set project. The easiest way to check that the project has been created in the correct folder (<em>mgpu-examples/</em> in our case) is to verify that right in the Console panel, to the right of the R version, appears only the path of our main folder (and not any of the subfolders, e.g.&nbsp;<em>mgpu-examples/code/</em> or <em>mgpu-examples/inputs/</em>).</p>
<p><img src="images/clipboard-3123546063.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-caution callout-titled" title="Just before to say `hello`">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Just before to say <code>hello</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>marbec-gpu</code> incorporates the possibility of working with RStudio (Server); however, this interface should be used ONLY to PREPARE our scripts before being executed using all the power of our server. In other words, within the RStudio environment we will be able to load not so big files and perform basic operations, but at no time should we execute a complex (heavy) process from there, but from <strong>Terminal</strong>.</p>
</div>
</div>
</section>
</section>
<section id="hello-world-simple-examples" class="level2">
<h2 data-anchor-id="hello-world-simple-examples"><code>Hello world!</code> (simple examples)</h2>
<section id="example-1-1" class="level3">
<h3 data-anchor-id="example-1-1">Example 1-1</h3>
<p>We will start with the simplest: create a script in R and print the (very famous) “Hello world!” message.</p>
<ul>
<li><p>We will start by opening an RStudio session from the JupyterLab environment (if you want to know how to get there, check the <a href="https://luislaum.github.io/blog/marbec-data-gpu-intro/marbec-data-gpu-intro.html">post</a> of Introduction to <code>marbec-gpu</code>).</p></li>
<li><p>Once inside the RStudio environment, we will create a new script (<em>File -&gt; New file -&gt; R script</em>) which will contain a single line:</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Hello world and hello marbec-gpu!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>Then, we will save that script with the name <em>code/ex1-1.R</em> (<em>code/</em> refers to a subfolder created previously inside the <em>working directory</em> of our project in RStudio).</p></li>
<li><p>Now comes the interesting part, inside our browser, we must go back to the Launcher tab and open a <strong>Terminal</strong> window (clicking on the corresponding icon).</p></li>
<li><p>By default, Terminal will open a session in the local folder assigned to our user. From there, we must get to the folder we have set as <em>working directory</em>; that is, the folder that our script will recognize as working directory (whether we have decided to use RStudio or not to create it or create a project inside it). Assuming that our working directory is the <code>mgpu-examples/</code> folder, we must reach it using the <code>cd</code> command:</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> mgpu-examples/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="How do we know that we have arrived at the correct folder?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How do we know that we have arrived at the correct folder?
</div>
</div>
<div class="callout-body-container callout-body">
<p>First, the prompt will indicate the name of the folder in which it is located.</p>
<p><img src="images/clipboard-3123546064.png" class="img-fluid"></p>
<p>In addition, we can run the <code>ls</code> command which will show the subfolders and files inside the folder we have reached. If everything matches, then we did well.</p>
<p><img src="images/clipboard-3123546065.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>Next, we execute the following command in the Terminal: <code>Rscript code/ex1-1.R</code> and the result should be just what would be shown in a usual R session.</li>
</ul>
<p><img src="images/clipboard-3123546066.png" class="img-fluid"></p>
</section>
<section id="example-1-2" class="level3">
<h3 data-anchor-id="example-1-2">Example 1-2</h3>
<p>In this next example, we will show a script that generates and saves files in our <em>working directory</em> where previously, we will create two new folders (<strong>figures/</strong> and <strong>outputs/</strong>) through the <code>mkdir</code> command as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> figures/ outputs/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Within the Terminal environment, it is not possible to observe graphics interactively (as in RStudio), so if you want to keep any figure, you must always include the code to save it within the script you execute. Depending on the graphical environment, we can use functions such as <code>png</code>, <code>bmp</code>, <code>jpeg</code>, <code>pdf</code> (for <strong>graphics</strong> environment), or <code>ggsave</code> (for <strong>ggplot2</strong> environment).</p>
</div>
</div>
<ul>
<li>Now, let’s go to RStudio to create the following script and save it in <strong>code/ex1-2.R</strong>:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print mtcars</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mtcars)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Export mtcars as a csv</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(<span class="at">x =</span> mtcars, <span class="at">file =</span> <span class="st">"outputs/mtcars.csv"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and save a scatterplot</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="at">filename =</span> <span class="st">"figures/fig_1-1.png"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> mtcars<span class="sc">$</span>mpg, <span class="at">y =</span> mtcars<span class="sc">$</span>disp, </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Miles per (US) gallon"</span>, <span class="at">ylab =</span> <span class="st">"Displacement (cu.in.)"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Next, we go back to the Terminal environment and run our new script with the command <code>Rscript code/ex1-2.R</code>. Immediately, the <code>mtcars</code> table will be displayed as that is what the first line of our script commands.</li>
</ul>
<p><img src="images/clipboard-3123546067.png" class="img-fluid"></p>
<ul>
<li>However, if we run the <code>ls</code> command in Terminal for the <em>figures/</em> and <em>outputs/</em> folders, we will see that the two files we ordered to be created inside our script appear.</li>
</ul>
<p><img src="images/clipboard-3123546068.png" class="img-fluid"></p>
<ul>
<li>If the files created are the ones we expect to collect from our analysis, we can download them through Filezilla (see the corresponding <a href="https://luislaum.github.io/blog/marbec-data-manage-files/marbec-data-manage-files.html">post</a>).</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Previewing figures">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Previewing figures
</div>
</div>
<div class="callout-body-container callout-body">
<p>While it is not possible to preview figures in Terminal or JupyterLab because they do not have an image viewer, it is possible to do so from the <code>marbec-data</code> web environment. However, this is a basic viewer and only available for the most common file types.</p>
</div>
</div>
</section>
</section>
<section id="hello-universe-parallel-process" class="level2">
<h2 data-anchor-id="hello-universe-parallel-process"><code>Hello universe!</code> (parallel process)</h2>
<section id="example-2-1-a-loop-in-a-single-core" class="level3">
<h3 data-anchor-id="example-2-1-a-loop-in-a-single-core">Example 2-1: A loop in a single core</h3>
<ul>
<li>We will start by creating a script (which we will save as <em>code/ex2-1.R</em>) containing a simple loop that generates 20 100x100 arrays with random values and saves them in separate csv files inside the <em>outputs/ex2-rndmats/</em> folder (remember to create that folder beforehand using <code>mkdir</code>):</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting number of rows and columns</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>row_n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>col_n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">20</span>)){</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create random matrix</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  rndMat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="fu">runif</span>(<span class="at">n =</span> row_n<span class="sc">*</span>col_n), <span class="at">nrow =</span> row_n, <span class="at">ncol =</span> col_n)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save matrix</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(<span class="at">x =</span> rndMat, </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">file =</span> <span class="fu">sprintf</span>(<span class="at">fmt =</span> <span class="st">"outputs/ex2-rndmats/mat_%02d.csv"</span>, i), </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print a message at the end of each step</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="at">fmt =</span> <span class="st">"Matrix %02d finished!</span><span class="sc">\n</span><span class="st">"</span>, i))</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Now, we will run our script in Terminal (with the command <code>Rscript code/ex2-1.R</code>) and we will observe that everything went well if the messages at the end of each step of the loop are displayed correctly and also if when we run the command <code>ls</code> on the target folder we see the files created:</li>
</ul>
<p><img src="images/clipboard-3123546069.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-tip callout-titled" title="Run a small example first">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Run a small example first
</div>
</div>
<div class="callout-body-container callout-body">
<p>Being already in a real execution, it is highly recommended always to try with a small example that allows us to corroborate that our script goes well BEFORE to pull out all the stops trying to execute the heavy process. In addition, if our script returns figures or files, executing a small corroboration script allows us to quickly check if the generated files are consistent with what we expect to obtain.</p>
</div>
</div>
</section>
<section id="example-2-2-a-loop-on-multiple-cores" class="level3">
<h3 data-anchor-id="example-2-2-a-loop-on-multiple-cores">Example 2-2: A loop on multiple cores</h3>
<ul>
<li>Starting from the previous example, we will convert our script into one that executes the processes in parallel. For this we will take advantage of the tools of the packages <a href="https://cran.r-project.org/package=foreach">foreach</a> and <a href="https://cran.r-project.org/package=doParallel">doParallel</a>. Note that the names of the files of this script will begin with the letters <code>mc_</code> to be able to recognize them with respect to those obtained in the previous example:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting number of rows and columns</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>row_n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>col_n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(foreach)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(doParallel)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Registering cluster</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="at">spec =</span> <span class="dv">20</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(<span class="at">cl =</span> cl)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Run multithread process</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="fu">seq</span>(<span class="dv">20</span>), <span class="at">.inorder =</span> <span class="cn">FALSE</span>) <span class="sc">%dopar%</span> {</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create random matrix</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  rndMat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="fu">runif</span>(<span class="at">n =</span> row_n<span class="sc">*</span>col_n), <span class="at">nrow =</span> row_n, <span class="at">ncol =</span> col_n)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save matrix</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(<span class="at">x =</span> rndMat, </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">file =</span> <span class="fu">sprintf</span>(<span class="at">fmt =</span> <span class="st">"outputs/ex2-rndmats/mc_mat_%02d.csv"</span>, i), </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Finish cluster</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Now, we will run our script in Terminal (with the command <code>Rscript code/ex2-2.R</code>) and we will observe that everything has gone well if when executing the command <code>ls</code> on the target folder we see the created files:</li>
</ul>
<p><img src="images/clipboard-3123546070.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A couple of things:</p>
<ul>
<li><p>In the script of the second example, <code>foreach</code> is assigned to an object (<code>out</code>) which will receive the last object generated within each step of the loop. If you only want to get files to be exported (figures, tables, NetCDF, etc.), be sure to leave a <code>NULL</code> in the last line of the loop. On the other hand, if you want to get an object and it is placed in that position, <code>foreach</code> will compile it using the <code>list</code> function, i.e.&nbsp;the final object (<code>out</code>) will be a <code>list</code> that will have as many levels as there are steps in the loop. Also, it is important to note that internally <code>foreach</code> runs a separate small R session so it is necessary to indicate the additional packages required through the <code>.packages</code> argument (see the following example).</p></li>
<li><p>The argument <code>spec = 20</code> inside <code>makeCluster</code> refers to the amount of threads that will be used to execute the loop. Remember that one of the options when creating your server in <code>marbec-gpu</code> was to choose the amount of CPUs (2, 4, 8, 16, 32…)? Well, it is precisely with this argument where you will indicate that amount of logical cores. Remember that another important aspect is the RAM. At a given time each process running within each thread will have to load everything that a single simple process would need. In other words, if in a single core process, in each step of our loop we have to load 5 NetCDF files that occupy 5 GB in RAM, if we run that process in multicore and we define <code>spec = 40</code>, at a given moment we will have to load 5GBx40 (200 GB) in RAM simultaneously. So not only you must choose well the configuration of your server (regarding the script you plan to run), but also an approximate of what is consumed in each independent process, in order not to saturate your server. <code>marbec-gpu</code> is great, but it has its limits.</p></li>
</ul>
</div>
</div>
</section>
</section>
</section>
<section id="es-empezando-a-trabajar-con-marbec-gpu" class="level1">
<h1>[ES] Empezando a trabajar con <code>marbec-gpu</code></h1>
<section id="un-poco-de-orden" class="level2">
<h2 data-anchor-id="un-poco-de-orden">Un poco de orden</h2>
<section id="creando-un-directorio-de-trabajo" class="level3">
<h3 data-anchor-id="creando-un-directorio-de-trabajo">Creando un directorio de trabajo</h3>
<p>Al igual que cuando se trabaja con RStudio de manera local (i.e.&nbsp;en nuestra PC), se recomienda definiendo claramente nuestro directorio de trabajo. Esto es sumamente importante porque cualquier proceso que ejecutemos (ya sea desde RStudio o Terminal) utilizará ese directorio como referencia para hallar los archivos de entrada, salida o incluso otros scripts.</p>
<p>Para nuestro caso, hemos creado una carpeta llamada <strong>mgpu-examples/</strong> en donde a su vez existen las subcarpetas <strong>code/</strong>, <strong>inputs/</strong>, <strong>outputs/</strong> y <strong>figures/</strong>. La creación de carpetas en <code>marbec-data</code> puede hacerse directamente desde la interfaz web (dando click a <em>File station</em> y luego usando el botón <em>Create folder</em>), pero también podemos copiar-pegar los elementos ya existentes en nuestra PC hacia la carpeta de trabajo.</p>
</section>
<section id="creando-un-proyecto-de-rstudio" class="level3">
<h3 data-anchor-id="creando-un-proyecto-de-rstudio">Creando un proyecto de RStudio</h3>
<p>Lo siguiente NO es obligatorio, pero sí muy útil, sobre todo cuando se trabaja con RStudio y es crear un proyecto de RStudio. Para ello, iremos a <em>File</em> y luego a <em>New Project</em>.</p>
<p><img src="images/clipboard-334464964.png" class="img-fluid"></p>
<p>Luego, en la ventana que nos aparece, daremos click a <em>Existing directory</em>, luego a <em>Browse</em> y daremos click a la carpeta que hemos definido como nuestro directorio de trabajo (en nuestro caso, <em>mgpu-examples/</em>). Luego, <em>Aceptar</em> y finalmente en el botón <em>Create Project</em>. Rstudio parpadeará un poco y luego nos mostrará la misma ventana, pero dentro del proyecto establecido. La manera más sencilla de comprobar que el proyecto se ha creado en la carpeta correcta (<em>mgpu-examples/</em> en nuestro caso) es verificando que justo en el panel de Console, a la derecha de la versión de R, aparezca únicamente la ruta de nuestra carpeta principal (y no alguna de las subcarpetas, e.g.&nbsp;<em>mgpu-examples/code/</em> o <em>mgpu-examples/inputs/</em>).</p>
<p><img src="images/clipboard-3123546063.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-caution callout-titled" title="Antes de decir `hello`">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Antes de decir <code>hello</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>marbec-gpu</code> incorpora la posibilidad de trabajar con RStudio (Server); sin embargo, esta interfaz deberá utilizarse ÚNICAMENTE para PREPARAR nuestros scripts antes de ser ejecutados utilizando toda la potencia de nuestro server. En otras palabras, dentro del entorno de RStudio podremos cargar archivos no tan grandes y realizar operaciones básicas, pero en ningún momento debemos ejecutar un proceso complejo (pesado) desde ahí, sino desde <strong>Terminal</strong>.</p>
</div>
</div>
</section>
</section>
<section id="hello-world-ejemplos-sencillos" class="level2">
<h2 data-anchor-id="hello-world-ejemplos-sencillos"><code>Hello world!</code> (ejemplos sencillos)</h2>
<section id="ejemplo-1-1" class="level3">
<h3 data-anchor-id="ejemplo-1-1">Ejemplo 1-1</h3>
<p>Iniciaremos con lo más sencillo: crear un script en R e imprimir el (famosísimo) mensaje “Hello world!”.</p>
<ul>
<li><p>Empezaremos abriendo una sesión de RStudio a partir del entorno JupyterLab (si desseas conocer cómo llegar hasta ahí, revisa el <a href="https://luislaum.github.io/blog/marbec-data-gpu-intro/marbec-data-gpu-intro.html">post</a> de Introducción a <code>marbec-gpu</code>).</p></li>
<li><p>Una vez dentro del entorno RStudio, crearemos un nuevo script (<em>File -&gt; New file -&gt; R script</em>) el cual contendrá una única línea:</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Hello world and hello marbec-gpu!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>Luego, guardaremos ese script con el nombre <em>code/ex1-1.R</em> (<em>code/</em> hace referencia a una subcarpeta creada anteriormente dentro del <em>working directory</em> de nuestro proyecto en RStudio).</p></li>
<li><p>Ahora viene lo interesante, dentro de nuestro navegador, debemos volver a la pestaña de Launcher y abrir una ventana de <strong>Terminal</strong> (dando click al ícono correspondiente).</p></li>
<li><p>Por defecto, Terminal abrirá una sesión en la carpeta local asignada a nuestro usuario. Desde ahí, debemos llegar a la carpeta que hemos establecido como <em>working directory</em>; es decir, la carpeta que nuestro script reconocerá como directorio de trabajo (ya sea que hayamos decidido usar RStudio o no para crearla o crear un proyecto dentro de ella). Asumiendo que nuestro working directory es la carpeta <code>mgpu-examples/</code>, debemos llegar a ella utilizando el comando <code>cd</code>:</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> mgpu-examples/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="¿cómo saber que hemos llegado a la carpeta correcta?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
¿cómo saber que hemos llegado a la carpeta correcta?
</div>
</div>
<div class="callout-body-container callout-body">
<p>En primer lugar, el prompt indicará el nombre de la carpeta en la que se encuentra.</p>
<p><img src="images/clipboard-3123546064.png" class="img-fluid"></p>
<p>Además, podemos ejecutar el comando <code>ls</code> con el que se mostrará las subcarpetas y archivos dentro de la carpeta a donde hemos llegado. Si todo coincide, pues lo hicimos bien.</p>
<p><img src="images/clipboard-3123546065.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>A continuación, ejecutaremos en la Terminal la siguiente orden: <code>Rscript code/ex1-1.R</code> y el resultado deberá ser que justo lo que se nos mostraría en una sesión habitual de R.</li>
</ul>
<p><img src="images/clipboard-3123546066.png" class="img-fluid"></p>
</section>
<section id="ejemplo-1-2" class="level3">
<h3 data-anchor-id="ejemplo-1-2">Ejemplo 1-2</h3>
<p>En este siguiente ejemplo, mostraremos un script que genera y guarda archivos en nuestro <em>working directory</em> en donde previamente, crearemos dos carpetas nuevas (<strong>figures/</strong> y <strong>outputs/</strong>) a través del comando <code>mkdir</code> del siguiente modo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> figures/ outputs/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dentro del entorno de Terminal, no es posible observar gráficos de forma interactiva (como en RStudio), por lo que si se desea conservar cualquier figura, se deberá incluir siempre el código para guardarla dentro del script que ejecutemos. Dependiendo del entorno gráfico, podemos usar funciones como <code>png</code>, <code>bmp</code>, <code>jpeg</code>, <code>pdf</code> (para entorno <strong>graphics</strong>), o <code>ggsave</code> (para entorno <strong>ggplot2</strong>).</p>
</div>
</div>
<ul>
<li>Ahora, vamos a RStudio para crear el siguiente script y a guardarlo en <strong>code/ex1-2.R</strong>:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print mtcars</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mtcars)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Export mtcars as a csv</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(<span class="at">x =</span> mtcars, <span class="at">file =</span> <span class="st">"outputs/mtcars.csv"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and save a scatterplot</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="at">filename =</span> <span class="st">"figures/fig_1-1.png"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> mtcars<span class="sc">$</span>mpg, <span class="at">y =</span> mtcars<span class="sc">$</span>disp, </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Miles per (US) gallon"</span>, <span class="at">ylab =</span> <span class="st">"Displacement (cu.in.)"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Seguidamente, volvemos al entorno de Terminal y ejecutaremos nuestro nuevo script con el comando <code>Rscript code/ex1-2.R</code>. Inmediatamente, se mostrará la tabla de <code>mtcars</code> ya que eso es lo que ordena la primera línea de nuestro script.</li>
</ul>
<p><img src="images/clipboard-3123546067.png" class="img-fluid"></p>
<ul>
<li>Sin embargo, si ejecutamos en Terminal el comando <code>ls</code> para las carpetas <em>figures/</em> y <em>outputs/</em>, veremos que aparecen los dos archivos que ordenamos crear dentro de nuestro script.</li>
</ul>
<p><img src="images/clipboard-3123546068.png" class="img-fluid"></p>
<ul>
<li>Si los archivos creados son los que esperamos recolectar de nuestro análisis, podemos descargarlos a través de Filezilla (ver el <a href="https://luislaum.github.io/blog/marbec-data-manage-files/marbec-data-manage-files.html">post</a> correspondiente).</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Previsualizar figuras">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Previsualizar figuras
</div>
</div>
<div class="callout-body-container callout-body">
<p>Si bien no es posible obtener una previsualización de figuras en Terminal o JupyterLab ya que estos no cuentan con un visor de imágenes, sí es posible hacerlo desde el entorno web de <code>marbec-data</code>. No obstante, se trata de un visor básico y solo disponible para los tipos de archivos más comunes.</p>
</div>
</div>
</section>
</section>
<section id="hello-universe-procesos-en-paralelo" class="level2">
<h2 data-anchor-id="hello-universe-procesos-en-paralelo"><code>Hello universe!</code> (procesos en paralelo)</h2>
<section id="ejemplo-2-1-un-bucle-en-un-solo-núcleo" class="level3">
<h3 data-anchor-id="ejemplo-2-1-un-bucle-en-un-solo-núcleo">Ejemplo 2-1: Un bucle en un solo núcleo</h3>
<ul>
<li>Empezaremos creando un script (que guardaremos como <em>code/ex2-1.R</em>) que contenga un bucle sencillo que genere 20 matrices de 100x100 con valores aleatorios y las guarde en archivos csv distintos dentro de la carpeta <em>outputs/ex2-rndmats/</em> (recuerda que debes crear previamente esa carpeta usando <code>mkdir</code>):</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting number of rows and columns</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>row_n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>col_n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">20</span>)){</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create random matrix</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  rndMat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="fu">runif</span>(<span class="at">n =</span> row_n<span class="sc">*</span>col_n), <span class="at">nrow =</span> row_n, <span class="at">ncol =</span> col_n)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save matrix</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(<span class="at">x =</span> rndMat, </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">file =</span> <span class="fu">sprintf</span>(<span class="at">fmt =</span> <span class="st">"outputs/ex2-rndmats/mat_%02d.csv"</span>, i), </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print a message at the end of each step</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="at">fmt =</span> <span class="st">"Matrix %02d finished!</span><span class="sc">\n</span><span class="st">"</span>, i))</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Ahora, ejecutaremos nuestro script en Terminal (con el comando <code>Rscript code/ex2-1.R</code>) y observaremos que todo ha ido bien si los mensajes al final de cada paso del bucle se muestran correctamente y si además al ejecutar el comando <code>ls</code> sobre la carpeta objetivo vemos los archivos creados:</li>
</ul>
<p><img src="images/clipboard-3123546069.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-tip callout-titled" title="Siempre correr un ejemplo pequeño primero">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Siempre correr un ejemplo pequeño primero
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ya en una ejecución real, lo recomendable es siempre intentar con un ejemplo pequeño que nos permita corroborar que nuestro script va bien ANTES de poner toda la carne en el asador tratando de ejecutar el proceso pesado. Además, si nuestro script devuelve figuras o archivos, ejecutar un script pequeño de corroboración nos permite revisar rápidamente si los archivos generados con coherentes con lo que esperamos obtener.</p>
</div>
</div>
</section>
<section id="ejemplo-2-2-un-bucle-en-múltiples-núcleos" class="level3">
<h3 data-anchor-id="ejemplo-2-2-un-bucle-en-múltiples-núcleos">Ejemplo 2-2: Un bucle en múltiples núcleos</h3>
<ul>
<li>Partiendo del ejemplo anterior, convertiremos nuestro script en uno que ejecute los procesos de forma paralela. Para ello aprovecharemos las herramientas de los paquetes <a href="https://cran.r-project.org/package=foreach">foreach</a> y <a href="https://cran.r-project.org/package=doParallel">doParallel</a>. Nótese que los nombres de los archivos de este script empezarán con las letras <code>mc_</code> para poder reconocerlos respecto a los obtenidos en el ejemplo anterior:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting number of rows and columns</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>row_n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>col_n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(foreach)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(doParallel)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Registering cluster</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="at">spec =</span> <span class="dv">20</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(<span class="at">cl =</span> cl)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Run multithread process</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="fu">seq</span>(<span class="dv">20</span>), <span class="at">.inorder =</span> <span class="cn">FALSE</span>) <span class="sc">%dopar%</span> {</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create random matrix</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  rndMat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="fu">runif</span>(<span class="at">n =</span> row_n<span class="sc">*</span>col_n), <span class="at">nrow =</span> row_n, <span class="at">ncol =</span> col_n)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save matrix</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(<span class="at">x =</span> rndMat, </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">file =</span> <span class="fu">sprintf</span>(<span class="at">fmt =</span> <span class="st">"outputs/ex2-rndmats/mc_mat_%02d.csv"</span>, i), </span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Finish cluster</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Ahora, ejecutaremos nuestro script en Terminal (con el comando <code>Rscript code/ex2-2.R</code>) y observaremos que todo ha ido bien si al ejecutar el comando <code>ls</code> sobre la carpeta objetivo vemos los archivos creados:</li>
</ul>
<p><img src="images/clipboard-3123546070.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Es importante notar un par de cosas:</p>
<ul>
<li><p>En el script del segundo ejemplo, <code>foreach</code> se encuentra asignado a un objeto (<code>out</code>) el cual recibirá el último objeto generado dentro de cada paso del loop. Si lo que se desea es únicamente obtener archivos que se exportarán (figuras, tablas, NetCDF, etc.), hay que asegurarse de dejar un <code>NULL</code> en la última línea dentro del bucle. Por otro lado, si lo que se desea es obtener un objeto y éste se coloca en esa posición, <code>foreach</code> lo compilará utilizando la función <code>list</code>, i.e.&nbsp;el objeto final (<code>out</code>) será una lista que tendrá tantos niveles como pasos haya en el bucle. Así mismo, es importante tener en cuenta que internamente <code>foreach</code> ejecuta una pequeña sesión de R aparte por lo que es necesario indicar los paquetes adicionales requeridos a través del argumento <code>.packages</code> (ver el ejemplo siguiente).</p></li>
<li><p>El argumento <code>spec = 20</code> dentro de <code>makeCluster</code> hace referencia a la cantidad de hilos de proceso que se utilizarán para ejecutar el bucle, ¿recuerdas que una de las opciones al momento de crear tu server en <code>marbec-gpu</code> era elegir la cantidad de CPUs (2, 4, 8, 16, 32…)? Bueno, pues es justamente con este argumento en donde indicarás esa cantidad de nucleos lógicos. Recuerda que otro aspecto importante es la RAM. En un momento determinado cada proceso corriendo dentro de cada hilo tendrá que cargar todo lo que necesitaría un solo proceso simple. Dicho de otro modo, si en un proceso de núcleo simple, en cada paso de nuestro bucle se tiene que cargar 5 archivos NetCDF que ocupan 5 GB en RAM, si ejecutamos ese proceso en multinúcleo y definimos <code>spec = 40</code>, en un momento se tendrán que cargar 5GBx40 (200 GB) en RAM en simultáneo. Así que no solo debes elegir bien la configuración de tu servidor (respecto al script que planeas ejecutar), sino también un aproximado de lo que se consume en cada proceso independiente, con el fin de no saturar tu servidor. <code>marbec-gpu</code> es grande, pero tiene sus límites.</p></li>
</ul>
</div>
</div>


</section>
</section>
</section>
</main> 
  </div>
</div>
 <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/luislaum\.github\.io\/home\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2024, Wencheng Lau-Medrano</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This website is built with <a href="https://github.com/LuisLauM/LuisLauM.github.io" target="_blank"><i class="fa-brands fa-github" title="GitHub octocat logo" aria-hidden="true"></i></a>, <a href="https://www.r-project.org/about.html" target="_blank"><i class="fa-brands fa-r-project" title="R Project" aria-hidden="true"></i></a> and <a href="https://quarto.org/" target="_blank">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>